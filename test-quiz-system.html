<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Quiz System</title>
    <link rel="stylesheet" href="styles-v2.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: var(--font-family-primary);
        }
        
        .test-section {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--color-border);
        }
        
        .test-title {
            color: var(--color-primary-500);
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            background: var(--color-primary-500);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .test-btn:hover {
            background: var(--color-primary-600);
            transform: translateY(-1px);
        }
        
        .test-btn.secondary {
            background: var(--color-gray-500);
        }
        
        .test-btn.secondary:hover {
            background: var(--color-gray-600);
        }
        
        .test-results {
            background: var(--color-gray-50);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-input, .test-select {
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }
        
        .quiz-test-area {
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            min-height: 400px;
        }
        
        .quiz-config-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .metric-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--color-border);
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-primary-500);
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pass { background: #10b981; }
        .status-fail { background: #ef4444; }
        .status-warn { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧩 Quiz System Test Suite</h1>
        
        <!-- Quiz Setup Test -->
        <div class="test-section">
            <h2 class="test-title">1. Quiz Setup & Configuration</h2>
            <div class="quiz-config-controls">
                <div>
                    <label>HSK Level:</label>
                    <select class="test-select" id="test-quiz-level">
                        <option value="1">HSK 1</option>
                        <option value="2">HSK 2</option>
                        <option value="3">HSK 3</option>
                        <option value="4">HSK 4</option>
                        <option value="5">HSK 5</option>
                        <option value="6">HSK 6</option>
                        <option value="all">All levels</option>
                    </select>
                </div>
                <div>
                    <label>Questions:</label>
                    <select class="test-select" id="test-quiz-questions">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                    </select>
                </div>
            </div>
            <div class="test-controls">
                <button class="test-btn" onclick="testQuizSetup()">Test Quiz Setup</button>
                <button class="test-btn" onclick="testQuizGeneration()">Test Question Generation</button>
                <button class="test-btn secondary" onclick="testQuizValidation()">Test Validation</button>
            </div>
            <div class="quiz-test-area" id="quiz-test-area">
                <p>Click "Test Quiz Setup" to initialize quiz interface here</p>
            </div>
            <div class="test-results" id="quiz-setup-results"></div>
        </div>
        
        <!-- Question Display Test -->
        <div class="test-section">
            <h2 class="test-title">2. Question Display & Options</h2>
            <div class="test-controls">
                <button class="test-btn" onclick="testQuestionDisplay()">Test Question Display</button>
                <button class="test-btn" onclick="testOptionSelection()">Test Option Selection</button>
                <button class="test-btn" onclick="testQuestionTypes()">Test Question Types</button>
                <button class="test-btn secondary" onclick="testQuestionValidation()">Test Validation</button>
            </div>
            <div class="test-results" id="question-display-results"></div>
        </div>
        
        <!-- Answer Submission Test -->
        <div class="test-section">
            <h2 class="test-title">3. Answer Submission & Scoring</h2>
            <div class="test-controls">
                <button class="test-btn" onclick="testAnswerSubmission()">Test Answer Submission</button>
                <button class="test-btn" onclick="testScoring()">Test Scoring System</button>
                <button class="test-btn" onclick="testFeedback()">Test Answer Feedback</button>
                <button class="test-btn secondary" onclick="testEdgeCases()">Test Edge Cases</button>
            </div>
            <div class="test-results" id="answer-submission-results"></div>
        </div>
        
        <!-- Quiz Navigation Test -->
        <div class="test-section">
            <h2 class="test-title">4. Quiz Navigation & Flow</h2>
            <div class="test-controls">
                <button class="test-btn" onclick="testQuizNavigation()">Test Navigation</button>
                <button class="test-btn" onclick="testQuizProgress()">Test Progress Tracking</button>
                <button class="test-btn" onclick="testQuizCompletion()">Test Quiz Completion</button>
                <button class="test-btn secondary" onclick="testQuizRestart()">Test Restart</button>
            </div>
            <div class="test-results" id="quiz-navigation-results"></div>
        </div>
        
        <!-- Results Display Test -->
        <div class="test-section">
            <h2 class="test-title">5. Results Display & Statistics</h2>
            <div class="test-controls">
                <button class="test-btn" onclick="testResultsDisplay()">Test Results Display</button>
                <button class="test-btn" onclick="testStatsIntegration()">Test Stats Integration</button>
                <button class="test-btn" onclick="testResultsCalculation()">Test Calculations</button>
                <button class="test-btn secondary" onclick="testResultsPersistence()">Test Persistence</button>
            </div>
            <div class="test-results" id="results-display-results"></div>
        </div>
        
        <!-- Performance Metrics -->
        <div class="test-section">
            <h2 class="test-title">6. Performance Metrics</h2>
            <div class="test-controls">
                <button class="test-btn" onclick="runQuizPerformanceTests()">Run Performance Tests</button>
                <button class="test-btn secondary" onclick="clearQuizMetrics()">Clear Metrics</button>
            </div>
            <div class="performance-metrics" id="quiz-performance-metrics">
                <div class="metric-card">
                    <div class="metric-value" id="quiz-setup-time">-</div>
                    <div class="metric-label">Setup Time (ms)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="question-render-time">-</div>
                    <div class="metric-label">Question Render (ms)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="answer-process-time">-</div>
                    <div class="metric-label">Answer Process (ms)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="questions-generated">-</div>
                    <div class="metric-label">Questions Generated</div>
                </div>
            </div>
        </div>
        
        <!-- Integration Test -->
        <div class="test-section">
            <h2 class="test-title">7. Full Quiz Integration Test</h2>
            <div class="test-controls">
                <button class="test-btn" onclick="runFullQuizTest()">Run Full Quiz Test</button>
                <button class="test-btn secondary" onclick="testQuizErrorRecovery()">Test Error Recovery</button>
            </div>
            <div class="test-results" id="quiz-integration-results"></div>
        </div>
    </div>

    <!-- Include main app -->
    <script src="app.js"></script>
    
    <script>
        // Test utilities
        let testApp = null;
        let quizMetrics = {
            setupTime: 0,
            questionRenderTime: 0,
            answerProcessTime: 0,
            questionsGenerated: 0
        };
        
        // Initialize test environment
        async function initializeQuizTestEnvironment() {
            try {
                if (!testApp) {
                    testApp = new HSKApp();
                    await testApp.init();
                }
                
                logResult('quiz-setup-results', '✅ Quiz test environment initialized successfully');
                return true;
            } catch (error) {
                logResult('quiz-setup-results', `❌ Failed to initialize quiz test environment: ${error.message}`);
                return false;
            }
        }
        
        // Test quiz setup
        async function testQuizSetup() {
            const startTime = performance.now();
            
            try {
                if (!testApp) {
                    const initialized = await initializeQuizTestEnvironment();
                    if (!initialized) return;
                }
                
                // Create mock quiz area
                const testArea = document.getElementById('quiz-test-area');
                testArea.innerHTML = `
                    <div class="quiz-setup" id="test-quiz-setup">
                        <h3>Configure Quiz</h3>
                        <div class="quiz-options">
                            <div class="control-group">
                                <label for="test-quiz-level-select">HSK Level</label>
                                <select id="test-quiz-level-select" class="select-input">
                                    <option value="1">HSK 1</option>
                                    <option value="2">HSK 2</option>
                                    <option value="3">HSK 3</option>
                                    <option value="4">HSK 4</option>
                                    <option value="5">HSK 5</option>
                                    <option value="6">HSK 6</option>
                                    <option value="all">All levels</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="test-quiz-questions-select">Number of Questions</label>
                                <select id="test-quiz-questions-select" class="select-input">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="30">30</option>
                                </select>
                            </div>
                        </div>
                        <button id="test-start-quiz" class="btn btn-primary">Start Quiz</button>
                    </div>
                    <div class="quiz-container" id="test-quiz-container" style="display: none;">
                        <div class="quiz-header">
                            <div class="quiz-progress">
                                <span id="test-quiz-current">1</span> / <span id="test-quiz-total">10</span>
                            </div>
                            <div class="quiz-score">
                                Score: <span id="test-quiz-score">0</span>
                            </div>
                        </div>
                        <div class="quiz-content">
                            <div class="question-display" id="test-quiz-question"></div>
                            <div class="quiz-options" id="test-quiz-options"></div>
                        </div>
                        <div class="quiz-actions">
                            <button id="test-quiz-submit" class="btn btn-primary" disabled>Confirm</button>
                            <button id="test-quiz-next" class="btn btn-primary" style="display: none;">Next</button>
                        </div>
                    </div>
                    <div class="quiz-results" id="test-quiz-results" style="display: none;">
                        <h3>Quiz Completed!</h3>
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-label">Final Score</div>
                                <div class="result-value" id="test-final-score">0/10</div>
                            </div>
                            <div class="result-card">
                                <div class="result-label">Percentage</div>
                                <div class="result-value" id="test-final-percentage">0%</div>
                            </div>
                        </div>
                        <button id="test-restart-quiz" class="btn btn-primary">New Quiz</button>
                    </div>
                `;
                
                const endTime = performance.now();
                quizMetrics.setupTime = Math.round(endTime - startTime);
                
                logResult('quiz-setup-results', `✅ Quiz setup interface created successfully`);
                logResult('quiz-setup-results', `📊 Setup completed in ${quizMetrics.setupTime}ms`);
                
                updateMetric('quiz-setup-time', quizMetrics.setupTime);
                
            } catch (error) {
                logResult('quiz-setup-results', `❌ Quiz setup test failed: ${error.message}`);
            }
        }
        
        // Test question generation
        async function testQuizGeneration() {
            const startTime = performance.now();
            
            try {
                if (!testApp) {
                    await initializeQuizTestEnvironment();
                }
                
                const level = document.getElementById('test-quiz-level').value;
                const questionCount = parseInt(document.getElementById('test-quiz-questions').value);
                
                // Test question generation
                let filtered = level === 'all' ? 
                    testApp.vocabulary : 
                    testApp.vocabulary.filter(word => word.level.toString() === level);
                
                if (filtered.length < questionCount) {
                    logResult('quiz-setup-results', `⚠️ Only ${filtered.length} words available for level ${level}`);
                    return;
                }
                
                const questions = testApp.generateQuizQuestions(filtered, questionCount);
                
                const endTime = performance.now();
                const generationTime = Math.round(endTime - startTime);
                
                quizMetrics.questionsGenerated = questions.length;
                
                logResult('quiz-setup-results', `✅ Generated ${questions.length} quiz questions`);
                logResult('quiz-setup-results', `📊 Generation completed in ${generationTime}ms`);
                logResult('quiz-setup-results', `🎯 Level: ${level}, Questions: ${questionCount}`);
                
                // Validate question structure
                let validQuestions = 0;
                questions.forEach((q, index) => {
                    if (q.word && q.options && q.options.length === 4 && q.type) {
                        validQuestions++;
                    } else {
                        logResult('quiz-setup-results', `❌ Invalid question structure at index ${index}`);
                    }
                });
                
                logResult('quiz-setup-results', `✅ ${validQuestions}/${questions.length} questions have valid structure`);
                
                updateMetric('questions-generated', quizMetrics.questionsGenerated);
                
            } catch (error) {
                logResult('quiz-setup-results', `❌ Question generation test failed: ${error.message}`);
            }
        }
        
        // Test question display
        async function testQuestionDisplay() {
            const startTime = performance.now();
            
            try {
                if (!testApp) {
                    await initializeQuizTestEnvironment();
                }
                
                // Generate a sample question
                const sampleWords = testApp.vocabulary.slice(0, 10);
                const questions = testApp.generateQuizQuestions(sampleWords, 1);
                
                if (questions.length === 0) {
                    logResult('question-display-results', '❌ No questions generated for display test');
                    return;
                }
                
                const question = questions[0];
                
                // Test question display logic
                let questionText = '';
                if (question.type === 'char-to-meaning') {
                    questionText = question.word.character;
                } else {
                    questionText = `${question.word.translation} (${question.word.pinyin})`;
                }
                
                const endTime = performance.now();
                quizMetrics.questionRenderTime = Math.round(endTime - startTime);
                
                logResult('question-display-results', `✅ Question display test completed`);
                logResult('question-display-results', `📝 Question: "${questionText}"`);
                logResult('question-display-results', `🎯 Type: ${question.type}`);
                logResult('question-display-results', `📊 Render time: ${quizMetrics.questionRenderTime}ms`);
                logResult('question-display-results', `🔢 Options: ${question.options.length}`);
                
                // Test options display
                question.options.forEach((option, index) => {
                    let optionText = '';
                    if (question.type === 'char-to-meaning') {
                        optionText = `${option.translation} (${option.pinyin})`;
                    } else {
                        optionText = option.character;
                    }
                    logResult('question-display-results', `   ${index + 1}. ${optionText}`);
                });
                
                updateMetric('question-render-time', quizMetrics.questionRenderTime);
                
            } catch (error) {
                logResult('question-display-results', `❌ Question display test failed: ${error.message}`);
            }
        }
        
        // Test answer submission
        async function testAnswerSubmission() {
            const startTime = performance.now();
            
            try {
                if (!testApp) {
                    await initializeQuizTestEnvironment();
                }
                
                // Generate a sample question
                const sampleWords = testApp.vocabulary.slice(0, 10);
                const questions = testApp.generateQuizQuestions(sampleWords, 1);
                const question = questions[0];
                
                // Find correct answer index
                const correctIndex = question.options.findIndex(opt => opt === question.word);
                
                // Test correct answer
                const isCorrect = correctIndex !== -1;
                
                const endTime = performance.now();
                quizMetrics.answerProcessTime = Math.round(endTime - startTime);
                
                logResult('answer-submission-results', `✅ Answer submission test completed`);
                logResult('answer-submission-results', `🎯 Correct answer index: ${correctIndex}`);
                logResult('answer-submission-results', `✅ Answer validation: ${isCorrect ? 'PASS' : 'FAIL'}`);
                logResult('answer-submission-results', `📊 Process time: ${quizMetrics.answerProcessTime}ms`);
                
                // Test scoring logic
                let score = 0;
                if (isCorrect) score++;
                
                logResult('answer-submission-results', `📈 Score calculation: ${score}/1`);
                
                updateMetric('answer-process-time', quizMetrics.answerProcessTime);
                
            } catch (error) {
                logResult('answer-submission-results', `❌ Answer submission test failed: ${error.message}`);
            }
        }
        
        // Test full quiz flow
        async function runFullQuizTest() {
            logResult('quiz-integration-results', '🧪 Starting full quiz integration test...');
            
            try {
                // 1. Initialize
                await initializeQuizTestEnvironment();
                logResult('quiz-integration-results', '✅ Step 1: Environment initialized');
                
                // 2. Test setup
                await testQuizSetup();
                logResult('quiz-integration-results', '✅ Step 2: Quiz setup tested');
                
                // 3. Test question generation
                await testQuizGeneration();
                logResult('quiz-integration-results', '✅ Step 3: Question generation tested');
                
                // 4. Test question display
                await testQuestionDisplay();
                logResult('quiz-integration-results', '✅ Step 4: Question display tested');
                
                // 5. Test answer submission
                await testAnswerSubmission();
                logResult('quiz-integration-results', '✅ Step 5: Answer submission tested');
                
                logResult('quiz-integration-results', '🎉 Full quiz integration test completed successfully!');
                
            } catch (error) {
                logResult('quiz-integration-results', `❌ Integration test failed: ${error.message}`);
            }
        }
        
        // Run performance tests
        async function runQuizPerformanceTests() {
            logResult('quiz-integration-results', '🚀 Starting quiz performance tests...');
            
            await testQuizSetup();
            await testQuizGeneration();
            await testQuestionDisplay();
            await testAnswerSubmission();
            
            logResult('quiz-integration-results', '✅ Performance tests completed');
        }
        
        // Utility functions
        function logResult(containerId, message) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }
        
        function updateMetric(metricId, value) {
            const element = document.getElementById(metricId);
            if (element) {
                element.textContent = value;
            }
        }
        
        function clearQuizMetrics() {
            quizMetrics = { setupTime: 0, questionRenderTime: 0, answerProcessTime: 0, questionsGenerated: 0 };
            updateMetric('quiz-setup-time', '-');
            updateMetric('question-render-time', '-');
            updateMetric('answer-process-time', '-');
            updateMetric('questions-generated', '-');
        }
        
        // Placeholder functions for other tests
        function testQuizValidation() {
            logResult('quiz-setup-results', '⚠️ Quiz validation test - placeholder implementation');
        }
        
        function testOptionSelection() {
            logResult('question-display-results', '⚠️ Option selection test - placeholder implementation');
        }
        
        function testQuestionTypes() {
            logResult('question-display-results', '⚠️ Question types test - placeholder implementation');
        }
        
        function testQuestionValidation() {
            logResult('question-display-results', '⚠️ Question validation test - placeholder implementation');
        }
        
        function testScoring() {
            logResult('answer-submission-results', '⚠️ Scoring test - placeholder implementation');
        }
        
        function testFeedback() {
            logResult('answer-submission-results', '⚠️ Feedback test - placeholder implementation');
        }
        
        function testEdgeCases() {
            logResult('answer-submission-results', '⚠️ Edge cases test - placeholder implementation');
        }
        
        function testQuizNavigation() {
            logResult('quiz-navigation-results', '⚠️ Quiz navigation test - placeholder implementation');
        }
        
        function testQuizProgress() {
            logResult('quiz-navigation-results', '⚠️ Quiz progress test - placeholder implementation');
        }
        
        function testQuizCompletion() {
            logResult('quiz-navigation-results', '⚠️ Quiz completion test - placeholder implementation');
        }
        
        function testQuizRestart() {
            logResult('quiz-navigation-results', '⚠️ Quiz restart test - placeholder implementation');
        }
        
        function testResultsDisplay() {
            logResult('results-display-results', '⚠️ Results display test - placeholder implementation');
        }
        
        function testStatsIntegration() {
            logResult('results-display-results', '⚠️ Stats integration test - placeholder implementation');
        }
        
        function testResultsCalculation() {
            logResult('results-display-results', '⚠️ Results calculation test - placeholder implementation');
        }
        
        function testResultsPersistence() {
            logResult('results-display-results', '⚠️ Results persistence test - placeholder implementation');
        }
        
        function testQuizErrorRecovery() {
            logResult('quiz-integration-results', '⚠️ Error recovery test - placeholder implementation');
        }
        
        // Auto-initialize on page load
        window.addEventListener('load', () => {
            console.log('🧪 Quiz System Test Suite loaded');
        });
    </script>
</body>
</html>