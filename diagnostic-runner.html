<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK Learning - Diagnostic Runner</title>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .console {
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 80vh;
            overflow-y: auto;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #00ff00;
        }
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .loading {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç HSK Learning Diagnostic Runner</h1>
        <p>Ejecutando diagn√≥stico completo de la aplicaci√≥n...</p>
    </div>
    
    <div id="status" class="status loading">üîÑ Ejecutando diagn√≥stico...</div>
    
    <div id="console" class="console">
Iniciando diagn√≥stico de HSK Learning...
Cargando aplicaci√≥n principal...
    </div>
    
    <!-- Cargar la aplicaci√≥n principal en un iframe oculto -->
    <iframe id="app-frame" src="index.html" style="display: none;" onload="startDiagnostic()"></iframe>
    
    <script>
        const consoleEl = document.getElementById('console');
        const statusEl = document.getElementById('status');
        
        // Capturar logs de consola
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
            consoleEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        console.log = function(...args) {
            logToConsole(args.join(' '), 'log');
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            logToConsole(args.join(' '), 'error');
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            logToConsole(args.join(' '), 'warn');
            originalWarn.apply(console, args);
        };
        
        async function startDiagnostic() {
            try {
                logToConsole('‚úÖ Aplicaci√≥n principal cargada');
                logToConsole('üîÑ Esperando inicializaci√≥n completa...');
                
                // Esperar a que la aplicaci√≥n se inicialice
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Acceder al contexto de la aplicaci√≥n
                const appFrame = document.getElementById('app-frame');
                const appWindow = appFrame.contentWindow;
                const appDocument = appFrame.contentDocument;
                
                if (!appWindow.HSKDiagnosticSystem) {
                    logToConsole('‚ùå Sistema de diagn√≥stico no encontrado en la aplicaci√≥n');
                    statusEl.textContent = '‚ùå Error: Sistema de diagn√≥stico no disponible';
                    statusEl.classList.remove('loading');
                    return;
                }
                
                logToConsole('üöÄ Iniciando sistema de diagn√≥stico...');
                
                // Crear instancia del sistema de diagn√≥stico en el contexto de la app
                const diagnostic = new appWindow.HSKDiagnosticSystem();
                
                logToConsole('üîç Ejecutando diagn√≥stico completo...');
                statusEl.textContent = 'üîç Ejecutando pruebas...';
                
                // Ejecutar diagn√≥stico
                const report = await diagnostic.runFullDiagnostic();
                
                logToConsole('üìä Diagn√≥stico completado');
                logToConsole('='.repeat(60));
                
                // Mostrar resumen
                logToConsole(`Estado General: ${report.overallStatus.toUpperCase()}`);
                logToConsole(`Total de Problemas: ${report.summary.totalIssues}`);
                logToConsole(`- Cr√≠ticos: ${report.summary.criticalIssues}`);
                logToConsole(`- Advertencias: ${report.summary.warningIssues}`);
                logToConsole(`- Informativos: ${report.summary.infoIssues}`);
                
                logToConsole('='.repeat(60));
                
                // Mostrar problemas cr√≠ticos
                const criticalIssues = diagnostic.issues.filter(issue => issue.severity === 'critical');
                if (criticalIssues.length > 0) {
                    logToConsole('üö® PROBLEMAS CR√çTICOS:');
                    criticalIssues.forEach((issue, index) => {
                        logToConsole(`${index + 1}. [${issue.component}] ${issue.description}`);
                    });
                } else {
                    logToConsole('‚úÖ No se encontraron problemas cr√≠ticos');
                }
                
                logToConsole('='.repeat(60));
                
                // Mostrar advertencias
                const warningIssues = diagnostic.issues.filter(issue => issue.severity === 'warning');
                if (warningIssues.length > 0) {
                    logToConsole('‚ö†Ô∏è ADVERTENCIAS:');
                    warningIssues.forEach((issue, index) => {
                        logToConsole(`${index + 1}. [${issue.component}] ${issue.description}`);
                    });
                } else {
                    logToConsole('‚úÖ No se encontraron advertencias');
                }
                
                logToConsole('='.repeat(60));
                
                // Mostrar recomendaciones
                logToConsole('üí° RECOMENDACIONES:');
                report.recommendations.forEach((rec, index) => {
                    logToConsole(`${index + 1}. ${rec}`);
                });
                
                // Actualizar estado
                const statusIcon = report.overallStatus === 'critical' ? 'üî¥' : 
                                 report.overallStatus === 'warning' ? 'üü°' : 'üü¢';
                statusEl.textContent = `${statusIcon} Diagn√≥stico completado - ${report.overallStatus.toUpperCase()}`;
                statusEl.classList.remove('loading');
                
                // Guardar reporte para an√°lisis posterior
                window.diagnosticReport = report;
                window.diagnosticSystem = diagnostic;
                
                logToConsole('üíæ Reporte guardado en window.diagnosticReport');
                logToConsole('üîß Sistema disponible en window.diagnosticSystem');
                logToConsole('‚úÖ Diagn√≥stico completado exitosamente');
                
            } catch (error) {
                logToConsole(`‚ùå Error ejecutando diagn√≥stico: ${error.message}`);
                statusEl.textContent = '‚ùå Error en diagn√≥stico';
                statusEl.classList.remove('loading');
                console.error('Diagnostic error:', error);
            }
        }
        
        // Funci√≥n para exportar reporte
        window.exportReport = function() {
            if (window.diagnosticReport) {
                const reportText = generateReportText(window.diagnosticReport, window.diagnosticSystem);
                const blob = new Blob([reportText], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hsk-diagnostic-report-${new Date().toISOString().split('T')[0]}.md`;
                a.click();
                URL.revokeObjectURL(url);
                logToConsole('üìÑ Reporte exportado como archivo Markdown');
            } else {
                logToConsole('‚ùå No hay reporte disponible para exportar');
            }
        };
        
        function generateReportText(report, diagnostic) {
            const timestamp = new Date().toISOString();
            
            return `# HSK Learning - Reporte de Diagn√≥stico

**Fecha:** ${new Date(report.timestamp).toLocaleString()}
**Estado General:** ${report.overallStatus.toUpperCase()}
**Total de Problemas:** ${report.summary.totalIssues}

## Resumen

- üî¥ Cr√≠ticos: ${report.summary.criticalIssues}
- üü° Advertencias: ${report.summary.warningIssues}
- üîµ Informativos: ${report.summary.infoIssues}

## Problemas Detectados

${diagnostic.issues.length === 0 ? '‚úÖ No se detectaron problemas' : 
  diagnostic.issues.map((issue, index) => 
    `### ${index + 1}. ${issue.component}
- **Severidad:** ${issue.severity.toUpperCase()}
- **Descripci√≥n:** ${issue.description}
- **Ubicaci√≥n:** ${issue.location || 'N/A'}
- **Timestamp:** ${issue.timestamp}`
  ).join('\n\n')}

## Recomendaciones

${report.recommendations.map((rec, index) => `${index + 1}. ${rec}`).join('\n')}

---
*Generado autom√°ticamente el ${timestamp}*
`;
        }
        
        logToConsole('üîß Diagnostic Runner inicializado');
        logToConsole('‚è≥ Esperando carga de la aplicaci√≥n...');
    </script>
</body>
</html>